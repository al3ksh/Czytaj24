<div class="flex items-center justify-between">
  <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Opinie</h2>
  <p class="text-sm text-slate-500 dark:text-slate-400">
    Średnia: <strong><%= (ratingStats?.aggregatedRating ?? book.aggregatedRating ?? 0).toFixed(1) %></strong> / 5.0
    <span class="text-xs">(<%= ratingStats?.ratingCount ?? book.ratingCount ?? 0 %>)</span>
  </p>
</div>

<% if (userName) { %>
  <div class="glass-panel p-6">
    <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Dodaj opinię</h3>
    <form method="POST" action="/book/<%= book._id %>/reviews" class="mt-4 space-y-4" data-review-form novalidate>
      <div>
        <label class="text-xs uppercase tracking-[0.3em] text-slate-500">Ocena</label>
        <div class="mt-2 flex items-center gap-3" data-rating-group>
          <% for (let star = 1; star <= 5; star++) { %>
            <label class="group cursor-pointer" data-star="<%= star %>">
              <input
                type="radio"
                name="rating"
                value="<%= star %>"
                class="sr-only peer"
              />
              <span class="text-2xl text-slate-300 transition group-hover:text-amber-400 dark:text-slate-600 dark:group-hover:text-amber-300" data-star-icon>★</span>
              <span class="sr-only"><%= star %></span>
            </label>
          <% } %>
          <span class="text-xs font-semibold text-slate-500 dark:text-slate-300" data-rating-output></span>
        </div>
        <% if (reviewErrors && !reviewErrors.reviewId && reviewErrors.rating) { %>
          <p class="mt-2 text-xs text-rose-600 dark:text-rose-300"><%= reviewErrors.rating %></p>
        <% } %>
      </div>
      <div>
        <label class="text-xs uppercase tracking-[0.3em] text-slate-500" for="comment">Komentarz</label>
        <textarea
          id="comment"
          name="comment"
          rows="4"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-brand focus:ring-brand dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
          placeholder="Co sądzisz o tej książce?"
        ></textarea>
        <% if (reviewErrors && !reviewErrors.reviewId && reviewErrors.comment) { %>
          <p class="mt-2 text-xs text-rose-600 dark:text-rose-300"><%= reviewErrors.comment %></p>
        <% } %>
      </div>
      <button
        type="submit"
        class="rounded-full bg-brand px-6 py-3 text-sm font-semibold uppercase tracking-wide text-white shadow shadow-orange-500/40 transition hover:bg-brand-dark"
      >
        Dodaj opinię
      </button>
    </form>
  </div>
<% } else { %>
  <div class="glass-panel p-6 text-center">
    <p class="text-sm text-slate-600 dark:text-slate-300">Zaloguj się, aby dodać opinię.</p>
    <div class="mt-4 flex justify-center gap-3">
      <a href="/login" class="rounded-full border px-4 py-2 text-sm font-semibold transition border-slate-300 text-slate-700 hover:border-slate-500 dark:border-white/10 dark:text-white dark:hover:bg-white/10">Logowanie</a>
      <a href="/register" class="rounded-full bg-brand px-4 py-2 text-sm font-semibold text-white hover:bg-brand-dark">Rejestracja</a>
    </div>
  </div>
<% } %>

<div class="space-y-4">
  <% if (reviews && reviews.length) { %>
    <% reviews.forEach((review) => { %>
      <article class="glass-panel p-6">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div class="space-y-1">
            <p class="text-sm font-semibold text-slate-900 dark:text-white"><%= review.userName || 'Użytkownik' %></p>
            <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
              <span>Dodano: <%= new Date(review.createdAt).toLocaleString('pl-PL') %></span>
              <% if (review.updatedAt) { %>
                <span class="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] uppercase tracking-wide text-slate-600 dark:bg-white/10 dark:text-slate-300">Edytowana</span>
              <% } %>
            </div>
          </div>
          <div class="flex items-center gap-2 rounded-full bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-600 dark:bg-amber-500/10 dark:text-amber-300">
            <span class="flex items-center gap-0.5" aria-hidden="true">
              <% for (let i = 0; i < review.rating; i++) { %>
                <span>★</span>
              <% } %>
            </span>
            <span>(<%= review.rating %>/5)</span>
          </div>
        </div>
        <% if (editReviewId && String(review._id) === String(editReviewId) && (userRole === 'admin' || (userId && String(review.userId) === String(userId)))) { %>
          <form method="POST" action="/book/<%= book._id %>/reviews/<%= review._id %>/edit" class="mt-4 space-y-3" data-review-form>
            <div class="flex items-center gap-3" data-rating-group>
              <% for (let star = 1; star <= 5; star++) { %>
                <label class="group cursor-pointer" data-star="<%= star %>">
                  <input
                    type="radio"
                    name="rating"
                    value="<%= star %>"
                    class="sr-only peer"
                    <%= review.rating === star ? 'checked' : '' %>
                  />
                  <span class="text-xl text-slate-300 transition group-hover:text-amber-400 dark:text-slate-600 dark:group-hover:text-amber-300" data-star-icon>★</span>
                  <span class="sr-only"><%= star %></span>
                </label>
              <% } %>
              <span class="text-xs font-semibold text-slate-500 dark:text-slate-300" data-rating-output></span>
            </div>
            <% if (reviewErrors && reviewErrors.reviewId && String(reviewErrors.reviewId) === String(review._id) && reviewErrors.rating) { %>
              <p class="text-xs text-rose-600 dark:text-rose-300"><%= reviewErrors.rating %></p>
            <% } %>
            <textarea
              name="comment"
              rows="3"
              class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-brand focus:ring-brand dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
            ><%= review.comment %></textarea>
            <% if (reviewErrors && reviewErrors.reviewId && String(reviewErrors.reviewId) === String(review._id) && reviewErrors.comment) { %>
              <p class="text-xs text-rose-600 dark:text-rose-300"><%= reviewErrors.comment %></p>
            <% } %>
            <div class="flex flex-wrap gap-3">
              <button type="submit" class="rounded-full bg-brand px-4 py-2 text-xs font-semibold uppercase tracking-wide text-white hover:bg-brand-dark">Zapisz</button>
              <a href="/book/<%= book._id %>" class="rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-700 hover:border-slate-500 dark:border-white/10 dark:text-slate-200" data-review-link>Anuluj</a>
            </div>
          </form>
        <% } else { %>
          <p class="mt-4 text-sm leading-relaxed text-slate-600 dark:text-slate-300"><%= review.comment %></p>
          <% if (userRole === 'admin' || (userId && String(review.userId) === String(userId))) { %>
            <div class="mt-4 flex flex-wrap gap-4 text-xs font-semibold">
              <a
                href="/book/<%= book._id %>?editReviewId=<%= review._id %><% if (reviewPagination && reviewPagination.page) { %>&reviewPage=<%= reviewPagination.page %><% } %>"
                class="text-slate-600 hover:text-slate-700 dark:text-slate-300"
                data-review-link
                data-edit-review-id="<%= review._id %>"
                data-review-page="<%= reviewPagination?.page || 1 %>"
              >
                Edytuj
              </a>
              <form method="POST" action="/book/<%= book._id %>/reviews/<%= review._id %>/delete" data-review-form>
                <button type="submit" class="text-rose-600 hover:text-rose-700 dark:text-rose-300">
                  Usuń opinię
                </button>
              </form>
            </div>
          <% } %>
        <% } %>
      </article>
    <% }) %>
  <% } else { %>
    <div class="rounded-2xl border border-dashed border-slate-200 p-6 text-center text-sm text-slate-500 dark:border-slate-700 dark:text-slate-400">
      Brak opinii. Bądź pierwszy!
    </div>
  <% } %>
</div>

<% if (reviewPagination && reviewPagination.pages > 1) { %>
  <div class="flex flex-wrap items-center justify-center gap-2">
    <% for (let page = 1; page <= reviewPagination.pages; page++) { %>
      <a
        href="/book/<%= book._id %>?reviewPage=<%= page %>"
        class="rounded-full px-3 py-1 text-xs font-semibold <%= page === reviewPagination.page ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900' : 'border border-slate-200 text-slate-600 hover:border-slate-400 dark:border-white/10 dark:text-slate-300' %>"
        data-review-link
        data-review-page="<%= page %>"
      >
        <%= page %>
      </a>
    <% } %>
  </div>
<% } %>
